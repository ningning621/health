 <html>

<title>Read CSV</title>
<head>
<link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
<link href="//fonts.googleapis.com/css?family=Raleway" rel="stylesheet" type = "text/css">
<link href="//fonts.googleapis.com/css?family=PT+Sans" rel="stylesheet" type = "text/css">
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="http://d3js.org/topojson.v2.min.js"></script>
</head>

<style>
#sidebar {
    position: relative;
    top: 0px;
    left: 0px;
    bottom: 0px;
    width: 20%;
    float: left;
    z-index: 1;
}
#legend {
	position: bottom;
}

#description h1 {

	 font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
	 font-size: 25px;
	 line-height: 40px;
	 padding: 10px 10px 0px 20px;
}

#subtitle {
	font-family: 'Ubuntu', sans-serif;
	font-size: 20px;
	padding-left: 100px;
	width: 70%;
	float: right;
	}

#subsub {
	font-family: 'Lato', sans-serif;
	font-size: 14px;
	padding-left: 100px;
	width: 70%;
	float: right;
}

#titleHR {
	padding-left: 20px;
	width: 300%;
}

hr {
	height: 2px;
	fill: #c6c6c6;
	border: 0;
	width: 20%;
	float: left;
	border-top: 2px solid #c6c6c6;
}

h2 {
	font-family: 'Lato', sans-serif;
	font-size: 16px;
	padding: 30px 10px 10px 20px;
}

</style>

<div id="sidebar">

	<div id = "description">
		<h1>Trends in Health Searches in the United States</h1>
	</div>
	<div id = "titleHR"><hr/></div>
	<div><h2>by Akhil Gopu, Lesley Huang, Yuji Yang</h2></div>

	<div id = "legend">
		<svg id="circles"></svg>
		<svg id="circles2"></svg>
		<script>
			var diseases = ["cancer", "stroke", "depression", "rehab", "vaccine", "obesity", "diabetes"];
			var colorList = {"cancer": "#fff189", "stroke": "#b2ef9b", "depression": "#c895fc", "rehab": "#ffae9c", "vaccine": "#6ab0de", "obesity": "#c6c6c6", "diabetes": "#a8e3d8"};

			var firstLegendKeys = ["cancer","stroke","rehab","diabetes"];

			var secondLegendKeys = ["cancer","stroke","depression","rehab","vaccine","obesity","diabetes"];

			function drawLegend(keys, legend, padding){
				var svg = d3.select(legend)
				.attr("height", 230)
				.style("padding-top", padding);
				svg.selectAll("g")
				.data(keys)
				.enter()
				.each(function (d, i) {
					
						var g = d3.select(this);
						g.append("circle")
						.attr("cx", 15)
						.attr("cy", i*25 + 10)
						.attr("r", 7)
						.style("fill", function(d) {
							return colorList[d];
						});
						g.append("text")
						.attr("x", 40)
						.attr("y", i*25 + 15)
						.text(function(i) {
							console.log(i);
							return i;
						})
						.style("font-family", "Lato")
						.style("font-size", "13");
				});
			};

		var firstLegend = drawLegend(firstLegendKeys, "#circles", 10);
		</script>
	</div>

	<script>var secondLegend = drawLegend(secondLegendKeys, "#circles2", 955);</script>
</div>

<script id = "repeatLegend">
/*function multiplyNode(node, count, deep) {
    for (var i = 0, copy; i < count - 1; i++) {
        copy = node.cloneNode(deep);
        node.parentNode.insertBefore(copy, node);
    }

}

multiplyNode(document.querySelector('#legend'), 2, true);*/



/*var legend = document.getElementById("legend");
var secondLegend = legend.cloneNode(true);

document.getElementById("sidebar").appendChild(secondLegend)
	.style("padding", "100");*/

</script>


<script>
var readData = d3.csv("RegionalInterestByConditionOverTime.csv", function(d) {
return {
	city: d.dma,
	state: d.dma.substr(d.dma.length - 2),
	geoCode: +d.geoCode,
	_2004_cancer: +d["2004+cancer"],
	_2004_cardiovascular: +d["2004+cardiovascular"],
	_2004_stroke: +d["2004+stroke"],
	_2004_depression: +d["2004+depression"],
	_2004_rehab: +d["2004+rehab"],
	_2004_vaccine: +d["2004+vaccine"],
	_2004_diarrhea: +d["2004+diarrhea"],
	_2004_obesity: +d["2004+obesity"],
	_2004_diabetes: +d["2004+diabetes"],
	_2005_cancer: +d["2005+cancer"],
	_2005_cardiovascular: +d["2005+cardiovascular"],
	_2005_stroke: +d["2005+stroke"],
	_2005_depression: +d["2005+depression"],
	_2005_rehab: +d["2005+rehab"],
	_2005_vaccine: +d["2005+vaccine"],
	_2005_diarrhea: +d["2005+diarrhea"],
	_2005_obesity: +d["2005+obesity"],
	_2005_diabetes: +d["2005+diabetes"],
	_2006_cancer: +d["2006+cancer"],
	_2006_cardiovascular: +d["2006+cardiovascular"],
	_2006_stroke: +d["2006+stroke"],
	_2006_depression: +d["2006+depression"],
	_2006_rehab: +d["2006+rehab"],
	_2006_vaccine: +d["2006+vaccine"],
	_2006_diarrhea: +d["2006+diarrhea"],
	_2006_obesity: +d["2006+obesity"],
	_2006_diabetes: +d["2006+diabetes"],
	_2007_cancer: +d["2007+cancer"],
	_2007_cardiovascular: +d["2007+cardiovascular"],
	_2007_stroke: +d["2007+stroke"],
	_2007_depression: +d["2007+depression"],
	_2007_rehab: +d["2007+rehab"],
	_2007_vaccine: +d["2007+vaccine"],
	_2007_diarrhea: +d["2007+diarrhea"],
	_2007_obesity: +d["2007+obesity"],
	_2007_diabetes: +d["2007+diabetes"],
	_2008_cancer: +d["2008+cancer"],
	_2008_cardiovascular: +d["2008+cardiovascular"],
	_2008_stroke: +d["2008+stroke"],
	_2008_depression: +d["2008+depression"],
	_2008_rehab: +d["2008+rehab"],
	_2008_vaccine: +d["2008+vaccine"],
	_2008_diarrhea: +d["2008+diarrhea"],
	_2008_obesity: +d["2008+obesity"],
	_2008_diabetes: +d["2008+diabetes"],
	_2009_cancer: +d["2009+cancer"],
	_2009_cardiovascular: +d["2009+cardiovascular"],
	_2009_stroke: +d["2009+stroke"],
	_2009_depression: +d["2009+depression"],
	_2009_rehab: +d["2009+rehab"],
	_2009_vaccine: +d["2009+vaccine"],
	_2009_diarrhea: +d["2009+diarrhea"],
	_2009_obesity: +d["2009+obesity"],
	_2009_diabetes: +d["2009+diabetes"],
	_2010_cancer: +d["2010+cancer"],
	_2010_cardiovascular: +d["2010+cardiovascular"],
	_2010_stroke: +d["2010+stroke"],
	_2010_depression: +d["2010+depression"],
	_2010_rehab: +d["2010+rehab"],
	_2010_vaccine: +d["2010+vaccine"],
	_2010_diarrhea: +d["2010+diarrhea"],
	_2010_obesity: +d["2010+obesity"],
	_2010_diabetes: +d["2010+diabetes"],
	_2011_cancer: +d["2011+cancer"],
	_2011_cardiovascular: +d["2011+cardiovascular"],
	_2011_stroke: +d["2011+stroke"],
	_2011_depression: +d["2011+depression"],
	_2011_rehab: +d["2011+rehab"],
	_2011_vaccine: +d["2011+vaccine"],
	_2011_diarrhea: +d["2011+diarrhea"],
	_2011_obesity: +d["2011+obesity"],
	_2011_diabetes: +d["2011+diabetes"],
	_2012_cancer: +d["2012+cancer"],
	_2012_cardiovascular: +d["2012+cardiovascular"],
	_2012_stroke: +d["2012+stroke"],
	_2012_depression: +d["2012+depression"],
	_2012_rehab: +d["2012+rehab"],
	_2012_vaccine: +d["2012+vaccine"],
	_2012_diarrhea: +d["2012+diarrhea"],
	_2012_obesity: +d["2012+obesity"],
	_2012_diabetes: +d["2012+diabetes"],
	_2013_cancer: +d["2013+cancer"],
	_2013_cardiovascular: +d["2013+cardiovascular"],
	_2013_stroke: +d["2013+stroke"],
	_2013_depression: +d["2013+depression"],
	_2013_rehab: +d["2013+rehab"],
	_2013_vaccine: +d["2013+vaccine"],
	_2013_diarrhea: +d["2013+diarrhea"],
	_2013_obesity: +d["2013+obesity"],
	_2013_diabetes: +d["2013+diabetes"],
	_2014_cancer: +d["2014+cancer"],
	_2014_cardiovascular: +d["2014+cardiovascular"],
	_2014_stroke: +d["2014+stroke"],
	_2014_depression: +d["2014+depression"],
	_2014_rehab: +d["2014+rehab"],
	_2014_vaccine: +d["2014+vaccine"],
	_2014_diarrhea: +d["2014+diarrhea"],
	_2014_obesity: +d["2014+obesity"],
	_2014_diabetes: +d["2014+diabetes"],
	_2015_cancer: +d["2015+cancer"],
	_2015_cardiovascular: +d["2015+cardiovascular"],
	_2015_stroke: +d["2015+stroke"],
	_2015_depression: +d["2015+depression"],
	_2015_rehab: +d["2015+rehab"],
	_2015_vaccine: +d["2015+vaccine"],
	_2015_diarrhea: +d["2015+diarrhea"],
	_2015_obesity: +d["2015+obesity"],
	_2015_diabetes: +d["2015+diabetes"],
	_2016_cancer: +d["2016+cancer"],
	_2016_cardiovascular: +d["2016+cardiovascular"],
	_2016_stroke: +d["2016+stroke"],
	_2016_depression: +d["2016+depression"],
	_2016_rehab: +d["2016+rehab"],
	_2016_vaccine: +d["2016+vaccine"],
	_2016_diarrhea: +d["2016+diarrhea"],
	_2016_obesity: +d["2016+obesity"],
	_2016_diabetes: +d["2016+diabetes"],
	_2017_cancer: +d["2017+cancer"],
	_2017_cardiovascular: +d["2017+cardiovascular"],
	_2017_stroke: +d["2017+stroke"],
	_2017_depression: +d["2017+depression"],
	_2017_rehab: +d["2017+rehab"],
	_2017_vaccine: +d["2017+vaccine"],
	_2017_diarrhea: +d["2017+diarrhea"],
	_2017_obesity: +d["2017+obesity"],
	_2017_diabetes: +d["2017+diabetes"]
};
}, function(data) {
genGraphs(data);
});

var diseases = ["cancer", "cardiovascular", "stroke", "depression", "rehab", "vaccine", "diarrhea", "obesity", "diabetes"];
var years = [2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017]

function genGraphs (data) {
	lineGraphDict = lineGraphData(data);
	mapGraphDict = mapGraphData(data);
	heatGraphDict = heatMapData(data, "cancer");
	diabetesDict = heatMapData(data, "diabetes");
	rehabDict = heatMapData(data, "rehab");
	strokeDict = heatMapData(data, "stroke");
	drawLineGraph(lineGraphDict);
}

function addToDict (dict, disease, count, year) {
	tmp = dict[year];
	if (disease in dict[year]) {
		tmp[disease] += count;
	}
	else {
		tmp[disease] = count;
	}
	dict[year] = tmp;
	return dict;
} 

function lineGraphData(data) {
	var dict = { }; // {disease, {year, count}}
	data.forEach(function(element) {
	   for(year in years) {
	  	for (disease in diseases)  {
	  		if (years[year] in dict) {
	  			dict = addToDict(dict, diseases[disease], element["_"+years[year]+"_"+diseases[disease]], years[year]);
	  		}
	  		else {
	  			var x = {};
	  			x[diseases[disease]] = element["_"+years[year]+"_"+diseases[disease]];
	  			dict[years[year]] = x;
	  		}
	  	}
	  }
	});
	for(year in years) {
		total = 0
	  	for (disease in diseases)  {
	  		total += dict[years[year]][diseases[disease]]
	  	}
	  	dict[years[year]]["total"] = total;
	  }
	return dict;
}

function getMax(dict) {
	var result = {};
	for (key in dict) {
		var max;
		obj = dict[key];
		max = Object.keys(obj).reduce((a, b) => obj[a] > obj[b] ? a : b); //from StackOverflow
		result[key] = max;
	}
	return result;
}

function heatMapData(data, x) {
	var dict = { }; // {state, {disease, count}}
	data.forEach(function(element) { //from StackOverflow
	   for(year in years) {
	  	for (disease in diseases)  {
	  		if (element.state in dict) {
	  			dict = addToDict(dict, diseases[disease], element["_"+years[year]+"_"+diseases[disease]], element.state);
	  		}
	  		else {
	  			var x = {};
	  			x[diseases[disease]] = element["_"+years[year]+"_"+diseases[disease]];
	  			dict[element.state] = x;
	  		}
	  	}
	  }
	});
	cancerMax = -1;
	cancerMin = 100000000000000000;
	for (state in dict) {
		if (dict[state][x] < cancerMin) {
			cancerMin = dict[state][x]
		} 
		if (dict[state][x] > cancerMax) {
			cancerMax = dict[state][x]
		}
	}
	var scale = d3.scaleLinear().range([.3,1]).domain([cancerMin, cancerMax]);
	result = { };
	for (state in dict) {
		result[state] = scale(dict[state][x]);
	}

	return result;
}

function mapGraphData(data){
	var dict = { }; // {state, {disease, count}}
	data.forEach(function(element) {
	   for(year in years) {
	  	for (disease in diseases)  {
	  		if (element.state in dict) {
	  			dict = addToDict(dict, diseases[disease], element["_"+years[year]+"_"+diseases[disease]], element.state);
	  		}
	  		else {
	  			var x = {};
	  			x[diseases[disease]] = element["_"+years[year]+"_"+diseases[disease]];
	  			dict[element.state] = x;
	  		}
	  	}
	  }
	});
	result = getMax(dict);
	return result;
}

function abbrState(input, to){
    
    var states = [
        ['Arizona', 'AZ'],
        ['Alabama', 'AL'],
        ['Alaska', 'AK'],
        ['Arizona', 'AZ'],
        ['Arkansas', 'AR'],
        ['California', 'CA'],
        ['Colorado', 'CO'],
        ['Connecticut', 'CT'],
        ['Delaware', 'D)'],
        ['Florida', 'FL'],
        ['Georgia', 'GA'],
        ['Hawaii', 'HI'],
        ['Idaho', 'ID'],
        ['Illinois', 'IL'],
        ['Indiana', 'IN'],
        ['Iowa', 'IA'],
        ['Kansas', 'KS'],
        ['Kentucky', 'KY'],
        ['Kentucky', 'KY'],
        ['Louisiana', 'LA'],
        ['Maine', 'ME'],
        ['Maryland', 'MD'],
        ['Massachusetts', 'MA'],
        ['Michigan', 'MI'],
        ['Minnesota', 'MN'],
        ['Mississippi', 'MS'],
        ['Missouri', 'MO'],
        ['Montana', 'MT'],
        ['Nebraska', 'NE'],
        ['Nevada', 'NV'],
        ['New Hampshire', 'NH'],
        ['New Mexico', 'NM'],
        ['New York', 'NY'],
        ['North Carolina', 'NC'],
        ['North Dakota', 'ND'],
        ['Ohio', 'OH'],
        ['Oklahoma', 'OK'],
        ['Oregon', 'OR'],
        ['Pennsylvania', 'PA'],
        ['South Carolina', 'SC'],
        ['South Dakota', 'SD'],
        ['Tennessee', 'TN'],
        ['Texas', 'TX'],
        ['Utah', 'UT'],
        ['Virginia', 'VA'],
        ['Washington', 'WA'],
        ['West Virginia', 'WV'],
        ['Wisconsin', 'WI'],
        ['Wyoming', 'WY'],
    ];

    if (to == 'abbr'){
        input = input.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        for(i = 0; i < states.length; i++){
            if(states[i][0] == input){
                return(states[i][1]);
            }
        }    
    } else if (to == 'name'){
        input = input.toUpperCase();
        for(i = 0; i < states.length; i++){
            if(states[i][1] == input){
                return(states[i][0]);
            }
        }    
    }
}

</script>

<style>
	.axis--x path {
	  display: none;
	}

	svg { 
		width: 80%; 
		float: right;
		position: relative;
	}

	.grid line {
	  stroke: lightgrey;
	  stroke-opacity: 0.7;
	  shape-rendering: crispEdges;
	}

	#svgTimeSeries svg {
		padding-bottom: 30;
	}
}
</style>
<div id="subtitle" style="padding-top: 30px">Most Frequent Health Searches<br/>By State, 2004 to 2017</div>
<div id="subtitle"><hr/></div>
<div id="subsub">*Insufficient data for Vermont, Rhode Island, and New Jersey</div>
<svg width="960" height="500" id = "usMap"></svg>
<div id="subtitle" style="padding-top: 30px">Choropleth of Cancer Related Searches<br/>By State, 2004 to 2017</div>
<div id="subtitle"><hr/></div>
<svg width="960" height="500" id = "cancerMap"></svg>
<div id="subtitle" style="padding-top: 30px">Relative Frequency of<br/>Health Search Terms Over Time</div>
<div id="subtitle"><hr/></div>
<svg width="960" height="500" id = "svgTimeSeries"></svg>
<script>
function drawLineGraph(lineData) {

	var margin = {top: 20, right: 20, bottom: 30, left: 170},
    width = 960 - margin.left - margin.right,
    height = 500 - margin.top - margin.bottom;


	var svg = d3.select("#svgTimeSeries").append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
  	.append("g")
    .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

	var scaleX = d3.scaleLinear().range([0,width]);
	var scaleY = d3.scaleLinear().range([height, 0]);

	scaleX.domain([2004,2017]);
	scaleY.domain([0, .13]);

	svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(scaleX).tickFormat(d3.format("d"))); //from StackOverflow

    svg.append("g")
      .call(d3.axisLeft(scaleY));

    var lineFunction = d3.line()
	                     .x(function(d) { return scaleX(d[0]); })
	                     .y(function(d) { return scaleY(d[1]); })
	                     .curve(d3.curveLinear); //from StackOverflow



	const sumValues = (obj) => Object.keys(obj).reduce((acc, value) => acc + obj[value], 0); //From StackOverflow
	for (var disease in diseases) {
		data = [];
		if (diseases[disease] == "cardiovascular" || diseases[disease] == "diarrhea") 
			continue;
		for (var year in lineData) {
			data.push([year, lineData[year][diseases[disease]] / sumValues(lineData[year])]);
			if (year == 2004) {
				svg.append("circle")
				   .attr("cx", scaleX(year))
				   .attr("cy", scaleY(lineData[year][diseases[disease]] / sumValues(lineData[year]) ))
				   .attr("r", 5)
				   .style("fill", colorList[diseases[disease]]);
			}
			if (year == 2017) {
				svg.append("circle")
				   .attr("cx", scaleX(year))
				   .attr("cy", scaleY(lineData[year][diseases[disease]] / sumValues(lineData[year]) ))
				   .attr("r", 5)
				   .style("fill", colorList[diseases[disease]]);
			}
		}


	
		 svg.append("path")
	        .attr("d", lineFunction(data))
	        .attr("stroke", function () {
			  	return colorList[diseases[disease]];
	        })
	        .attr("stroke-width", 3)
	        .attr("fill", "none");
	    }

	function drawXGridlines() {		
    return d3.axisBottom(scaleX)
        .ticks(10)
	}

	svg.append("g")			
      .attr("class", "grid")
      .attr("transform", "translate(0," + height + ")")
      .call(drawXGridlines()
          .tickSize(-height)
          .tickFormat("")
      );


	svg.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate(" + -50 + "," + (height/2) + ")rotate(-90)")
		.attr("font-family", "'Ubuntu', sans-serif")
		.text("Percentage of Annual Search Term Frequency");

	svg.append("text")
		.attr("text-anchor", "middle")
		.attr("transform", "translate("+ (width/2) +","+(height + 30) + ")")
		.attr("font-family", "'Ubuntu', sans-serif")
		.text("Year");

}

</script>
<script id = "drawTimeSeries">

var svg = d3.select("#drawTimeSeries"),
	margin = {top: 20, right: 80, bottom: 30, left: 50},
    width = svg.attr("width") - margin.left - margin.right,
    height = svg.attr("height") - margin.top - margin.bottom,
    g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

var scaleX = d3.scaleLinear().range([0,width]);
var scaleY = d3.scaleLinear().range([height, 0]);

var line1 = d3.line()
	.x(function (d) {return scaleX(d.year)})
	.y(function (d) {return scaleY(d.cancer)});

//scaleX.domain(d3.extent(mapGraphData, function(data) {return data.years}));
//scaleY.domain([0, d3.max(mapGraphData, function(data) {
	//return Math.max(d.cancer, d.ardiovascular, d.stroke, d.depression, d.rehab, d.vaccine, d.diarrhea, d.obesity, d.diabetes)})]);
</script>

<script id="drawUSMap">
	
var svgMap = d3.select("#usMap");
var projection = d3.geoAlbersUsa().scale(900);
var pathGenerator = d3.geoPath().projection(projection);

var rawData;
var states;

var colors = {"stroke": "#b2ef9b", "cancer": "#fff189", "diabetes": "#a8e3d8", "rehab": "#ffae9c"};
d3.json("us-states.json", function (data) {

	for (var i =  0; i < data.features.length; i++) {
  	var ab = abbrState(data.features[i].properties.name, "abbr");
  	if (mapGraphDict[ab]) {
  		data.features[i].properties.disease = mapGraphDict[ab];
  	}
  }
   svgMap.selectAll("path")
  .data(data.features)
  .enter()
  .append("path")
	  .attr("d", pathGenerator)
	  .style("stroke", "#fff")
	  .style("stroke-width", "1")
	  .style("fill", function(d) {
	  	var value = d.properties.disease;

	  	if (colors[value]) {
	  		return colors[value];
	  	} else {
	  		return "rgb(240, 240, 240)";
	  	}
	  });
});
</script>

<script id="cancerMap">
	
var cancerMap = d3.select("#cancerMap");
var projection = d3.geoAlbersUsa().scale(900);
var pathGenerator = d3.geoPath().projection(projection);

var rawData;
var states;

d3.json("us-states.json", function (data) {

	for (var i =  0; i < data.features.length; i++) {
  	var abb = abbrState(data.features[i].properties.name, "abbr");
  	
  	if (heatGraphDict[abb]) {
  		data.features[i].properties.heat = heatGraphDict[abb];
  	}
  }
   cancerMap.selectAll("path")
  .data(data.features)
  .enter()
  .append("path")
	  .attr("d", pathGenerator)
	  .style("stroke", "#fff")
	  .style("stroke-width", "1")
	  .style("fill", function(d) {
		if (d.properties.name == "Vermont" || d.properties.name == "Rhode Island" ||
			d.properties.name == "New Jersey") {
			return "rgb(240, 240, 240)";
		}
		return "#ffea42";
	  })
	  .style("opacity", function(d) {
	  	var value = d.properties.heat;
	  	return value;
	  });
});
</script>

</html>

